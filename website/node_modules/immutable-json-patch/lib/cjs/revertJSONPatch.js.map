{"version":3,"file":"revertJSONPatch.js","names":["_immutabilityHelpers","require","_immutableJSONPatch","_jsonPointer","_utils","revertJSONPatch","document","operations","options","allRevertOperations","before","operation","revertOperations","path","parsePath","op","revertAdd","revertRemove","revertReplace","revertCopy","revertMove","parseFrom","from","Error","JSON","stringify","updatedJson","res","json","concat","undefined","immutableJSONPatch","existsIn","compileJSONPointer","value","getIn","isArrayItem","length","startsWith","move"],"sources":["../../src/revertJSONPatch.ts"],"sourcesContent":["import { existsIn, getIn } from './immutabilityHelpers.js'\nimport { immutableJSONPatch, isArrayItem, parseFrom, parsePath } from './immutableJSONPatch.js'\nimport { compileJSONPointer } from './jsonPointer.js'\nimport type {\n  JSONPatchAdd,\n  JSONPatchDocument,\n  JSONPatchMove,\n  JSONPatchOperation,\n  JSONPatchOptions,\n  JSONPatchRemove,\n  JSONPatchReplace,\n  JSONPath,\n  RevertJSONPatchOptions\n} from './types.js'\nimport { startsWith } from './utils.js'\n\n/**\n * Create the inverse of a set of json patch operations\n * @param document\n * @param operations Array with JSON patch actions\n * @param [options]\n * @return Returns the operations to revert the changes\n */\nexport function revertJSONPatch<T, U>(\n  document: T,\n  operations: JSONPatchDocument,\n  options?: RevertJSONPatchOptions\n): JSONPatchDocument {\n  let allRevertOperations: JSONPatchDocument = []\n\n  const before: JSONPatchOptions['before'] = <TT, UU>(\n    document: TT,\n    operation: JSONPatchOperation\n  ): { document?: UU; operation?: JSONPatchOperation } => {\n    let revertOperations: JSONPatchDocument\n    const path = parsePath(document, operation.path)\n    if (operation.op === 'add') {\n      revertOperations = revertAdd(document, path)\n    } else if (operation.op === 'remove') {\n      revertOperations = revertRemove(document, path)\n    } else if (operation.op === 'replace') {\n      revertOperations = revertReplace(document, path)\n    } else if (operation.op === 'copy') {\n      revertOperations = revertCopy(document, path)\n    } else if (operation.op === 'move') {\n      revertOperations = revertMove(document, path, parseFrom(operation.from))\n    } else if (operation.op === 'test') {\n      revertOperations = []\n    } else {\n      throw new Error(`Unknown JSONPatch operation ${JSON.stringify(operation)}`)\n    }\n\n    let updatedJson: UU\n    if (options?.before) {\n      const res = options.before(document, operation, revertOperations)\n      if (res?.revertOperations) {\n        revertOperations = res.revertOperations\n      }\n      if (res?.document) {\n        updatedJson = res.document as unknown as UU\n      }\n\n      // @ts-ignore\n      if (res?.json) {\n        // TODO: deprecated since v5.0.0. Cleanup this warning some day\n        throw new Error(\n          'Deprecation warning: returned object property \".json\" has been renamed to \".document\"'\n        )\n      }\n    }\n\n    allRevertOperations = revertOperations.concat(allRevertOperations)\n\n    if (updatedJson !== undefined) {\n      return {\n        document: updatedJson\n      }\n    }\n  }\n\n  immutableJSONPatch<U, T>(document, operations, { before })\n\n  return allRevertOperations\n}\n\nfunction revertReplace<T>(document: T, path: JSONPath): [JSONPatchReplace] | [] {\n  return existsIn(document, path)\n    ? [\n        {\n          op: 'replace',\n          path: compileJSONPointer(path),\n          value: getIn(document, path)\n        }\n      ]\n    : []\n}\n\nfunction revertRemove<T>(document: T, path: JSONPath): [JSONPatchAdd] {\n  return [\n    {\n      op: 'add',\n      path: compileJSONPointer(path),\n      value: getIn(document, path)\n    }\n  ]\n}\n\nfunction revertAdd<T>(document: T, path: JSONPath): [JSONPatchRemove] | [JSONPatchReplace] | [] {\n  if (isArrayItem(document, path) || !existsIn(document, path)) {\n    return [\n      {\n        op: 'remove',\n        path: compileJSONPointer(path)\n      }\n    ]\n  }\n  return revertReplace(document, path)\n}\n\nfunction revertCopy<T>(document: T, path: JSONPath): [JSONPatchRemove] | [JSONPatchReplace] | [] {\n  return revertAdd(document, path)\n}\n\nfunction revertMove<T>(\n  document: T,\n  path: JSONPath,\n  from: JSONPath\n): [JSONPatchReplace] | [JSONPatchMove] | [JSONPatchMove, JSONPatchAdd] {\n  if (path.length < from.length && startsWith(from, path)) {\n    // replacing the parent with the child\n    return [\n      {\n        op: 'replace',\n        path: compileJSONPointer(path),\n        value: document\n      }\n    ]\n  }\n\n  const move: JSONPatchMove = {\n    op: 'move',\n    from: compileJSONPointer(path),\n    path: compileJSONPointer(from)\n  }\n\n  if (!isArrayItem(document, path) && existsIn(document, path)) {\n    // the move replaces an existing value in an object\n    return [move, ...revertRemove(document, path)]\n  }\n  return [move]\n}\n"],"mappings":"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","ignoreList":[]}