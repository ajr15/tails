{"version":3,"file":"immutableJSONPatch.js","names":["deleteIn","existsIn","getIn","insertAt","setIn","compileJSONPointer","parseJSONPointer","initial","isEqual","last","immutableJSONPatch","document","operations","options","updatedDocument","i","length","validateJSONPatchOperation","operation","before","result","undefined","json","Error","previousDocument","path","parsePath","op","add","value","remove","replace","copy","parseFrom","from","move","test","JSON","stringify","after","isArrayItem","removedJson","actualValue","parent","Array","isArray","resolvePathIndex","parentPath","concat","ops","includes","pointer","fromPointer"],"sources":["../../src/immutableJSONPatch.ts"],"sourcesContent":["import { deleteIn, existsIn, getIn, insertAt, setIn } from './immutabilityHelpers.js'\nimport { compileJSONPointer, parseJSONPointer } from './jsonPointer.js'\nimport type {\n  JSONPatchDocument,\n  JSONPatchOperation,\n  JSONPatchOptions,\n  JSONPath,\n  JSONPointer\n} from './types'\nimport { initial, isEqual, last } from './utils.js'\n\n/**\n * Apply a patch to a JSON object\n * The original JSON object will not be changed,\n * instead, the patch is applied in an immutable way\n */\nexport function immutableJSONPatch<T, U = unknown>(\n  document: U,\n  operations: JSONPatchDocument,\n  options?: JSONPatchOptions\n): T {\n  let updatedDocument = document as unknown as T\n\n  for (let i = 0; i < operations.length; i++) {\n    validateJSONPatchOperation(operations[i])\n\n    let operation: JSONPatchOperation = operations[i]\n\n    // TODO: test before\n    if (options?.before) {\n      const result = options.before(updatedDocument, operation)\n      if (result !== undefined) {\n        if (result.document !== undefined) {\n          updatedDocument = result.document as T\n        }\n\n        // @ts-ignore\n        if (result.json !== undefined) {\n          // TODO: deprecated since v5.0.0. Cleanup this warning some day\n          throw new Error(\n            'Deprecation warning: returned object property \".json\" has been renamed to \".document\"'\n          )\n        }\n        if (result.operation !== undefined) {\n          operation = result.operation\n        }\n      }\n    }\n\n    const previousDocument = updatedDocument\n    const path = parsePath(updatedDocument, operation.path)\n    if (operation.op === 'add') {\n      updatedDocument = add(updatedDocument, path, operation.value)\n    } else if (operation.op === 'remove') {\n      updatedDocument = remove(updatedDocument, path)\n    } else if (operation.op === 'replace') {\n      updatedDocument = replace(updatedDocument, path, operation.value)\n    } else if (operation.op === 'copy') {\n      updatedDocument = copy(updatedDocument, path, parseFrom(operation.from))\n    } else if (operation.op === 'move') {\n      updatedDocument = move(updatedDocument, path, parseFrom(operation.from))\n    } else if (operation.op === 'test') {\n      test(updatedDocument, path, operation.value)\n    } else {\n      throw new Error(`Unknown JSONPatch operation ${JSON.stringify(operation)}`)\n    }\n\n    // TODO: test after\n    if (options?.after) {\n      const result = options.after(updatedDocument, operation, previousDocument)\n      if (result !== undefined) {\n        updatedDocument = result as T\n      }\n    }\n  }\n\n  return updatedDocument\n}\n\n/**\n * Replace an existing item\n */\nexport function replace<T, U, V>(document: U, path: JSONPath, value: V): T {\n  return existsIn(document, path) ? setIn(document, path, value) : (document as unknown as T)\n}\n\n/**\n * Remove an item or property\n */\nexport function remove<T, U>(document: U, path: JSONPath): T {\n  return deleteIn(document, path)\n}\n\n/**\n * Add an item or property\n */\nexport function add<T, U, V>(document: U, path: JSONPath, value: V): T {\n  if (isArrayItem(document, path)) {\n    return insertAt(document, path, value) as unknown as T\n  }\n\n  return setIn(document, path, value)\n}\n\n/**\n * Copy a value\n */\nexport function copy<T, U>(document: U, path: JSONPath, from: JSONPath): T {\n  const value = getIn(document, from)\n\n  if (isArrayItem(document, path)) {\n    return insertAt(document, path, value) as unknown as T\n  }\n\n  return setIn(document, path, value)\n}\n\n/**\n * Move a value\n */\nexport function move<T, U>(document: U, path: JSONPath, from: JSONPath): T {\n  const value = getIn(document, from)\n  const removedJson = deleteIn(document, from)\n\n  return isArrayItem(removedJson, path)\n    ? (insertAt(removedJson, path, value) as unknown as T)\n    : setIn(removedJson, path, value)\n}\n\n/**\n * Test whether the data contains the provided value at the specified path.\n * Throws an error when the test fails\n */\nexport function test<T, U>(document: T, path: JSONPath, value: U) {\n  if (value === undefined) {\n    throw new Error(`Test failed: no value provided (path: \"${compileJSONPointer(path)}\")`)\n  }\n\n  if (!existsIn(document, path)) {\n    throw new Error(`Test failed: path not found (path: \"${compileJSONPointer(path)}\")`)\n  }\n\n  const actualValue = getIn(document, path)\n  if (!isEqual(actualValue, value)) {\n    throw new Error(`Test failed, value differs (path: \"${compileJSONPointer(path)}\")`)\n  }\n}\n\nexport function isArrayItem(document: unknown, path: JSONPath): document is Array<unknown> {\n  if (path.length === 0) {\n    return false\n  }\n\n  const parent = getIn(document, initial(path))\n\n  return Array.isArray(parent)\n}\n\n/**\n * Resolve the path index of an array, resolves indexes '-'\n * @returns Returns the resolved path\n */\nexport function resolvePathIndex<T>(document: T, path: JSONPath): JSONPath {\n  if (last(path) !== '-') {\n    return path\n  }\n\n  const parentPath = initial(path)\n  const parent = getIn(document, parentPath)\n\n  // @ts-ignore\n  return parentPath.concat(parent.length)\n}\n\n/**\n * Validate a JSONPatch operation.\n * Throws an error when there is an issue\n */\nexport function validateJSONPatchOperation(operation: JSONPatchOperation) {\n  // TODO: write unit tests\n  const ops = ['add', 'remove', 'replace', 'copy', 'move', 'test']\n\n  if (!ops.includes(operation.op)) {\n    throw new Error(`Unknown JSONPatch op ${JSON.stringify(operation.op)}`)\n  }\n\n  if (typeof operation.path !== 'string') {\n    throw new Error(\n      `Required property \"path\" missing or not a string in operation ${JSON.stringify(operation)}`\n    )\n  }\n\n  if (operation.op === 'copy' || operation.op === 'move') {\n    if (typeof operation.from !== 'string') {\n      throw new Error(\n        `Required property \"from\" missing or not a string in operation ${JSON.stringify(operation)}`\n      )\n    }\n  }\n}\n\nexport function parsePath<T>(document: T, pointer: JSONPointer): JSONPath {\n  return resolvePathIndex(document, parseJSONPointer(pointer))\n}\n\nexport function parseFrom(fromPointer: JSONPointer): JSONPath {\n  return parseJSONPointer(fromPointer)\n}\n"],"mappings":"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","ignoreList":[]}